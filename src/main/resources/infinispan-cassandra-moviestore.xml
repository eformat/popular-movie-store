<?xml version="1.0" encoding="UTF-8"?>
<infinispan xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="urn:infinispan:config:9.0 http://www.infinispan.org/schemas/infinispan-config-9.0.xsd"
            xmlns="urn:infinispan:config:9.0">

  <jgroups transport="org.infinispan.remoting.transport.jgroups.JGroupsTransport">
    <!-- This will be tcp for local mode and kubernetes for cloud mode -->
    <stack-file name="configurationFile" path="default-configs/default-jgroups-kubernetes.xml"/>
  </jgroups>

  <!-- http://infinispan.org/docs/cachestores/cassandra/ -->
  <cache-container name="clustered" default-cache="popular-movies-cache" statistics="true">

    <!--transport stack="configurationFile" cluster="PopularMovieStore" lock-timeout="60000"/-->

    <!-- The cache that manages HTTP session-->
    <distributed-cache name="moviestore-sessions-cache" mode="SYNC" start="EAGER" statistics="true">
      <store-as-binary keys="true" values="true"/>
      <persistence passivation="false">
        <store class="org.infinispan.persistence.cassandra.CassandraStore" shared="true">
          <write-behind />
          <property name="autoCreateKeyspace">true</property>
          <property name="keyspace">moviestore</property>
          <property name="entryTable">sessions</property>
          <property name="consistencyLevel">LOCAL_ONE</property>
          <property name="serialConsistencyLevel">SERIAL</property>
          <property name="servers">127.0.0.1[9042]</property>
          <property name="connectionPool.heartbeatIntervalSeconds">30</property>
          <property name="connectionPool.idleTimeoutSeconds">120</property>
          <property name="connectionPool.poolTimeoutMillis">5</property>
        </store>
      </persistence>
    </distributed-cache>

    <!-- Cache that will hold the movie details fetched via moviedb api -->
    <distributed-cache name="popular-movies-cache" mode="SYNC" start="EAGER" statistics="true">
      <expiration lifespan="86400000"/>
      <persistence passivation="false">
        <store class="org.infinispan.persistence.cassandra.CassandraStore" shared="true">
          <write-behind />
          <property name="autoCreateKeyspace">true</property>
          <property name="keyspace">moviestore</property>
          <property name="entryTable">movies</property>
          <property name="consistencyLevel">LOCAL_ONE</property>
          <property name="serialConsistencyLevel">SERIAL</property>
          <property name="servers">127.0.0.1[9042]</property>
          <property name="connectionPool.heartbeatIntervalSeconds">30</property>
          <property name="connectionPool.idleTimeoutSeconds">120</property>
          <property name="connectionPool.poolTimeoutMillis">5</property>
        </store>
      </persistence>
    </distributed-cache>

  </cache-container>


</infinispan>
